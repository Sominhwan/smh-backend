<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.smh.config.jwt.dao.UserDAO">
	<!-- 회원가입 -->
	<insert id="insertUser">
		INSERT INTO user_info(
			email,
			password,
			korea_name,
			foreigner_name,
			birth_date,
			gender,
			foreigner_status,
			phone_num,
			mobile_carrier,
			private_info_terms,
			unique_identify_terms,
			mobile_carrier_terms,
			create_at
		)
		VALUES(
			#{email},
			#{password},
			#{koreaName},
			#{foreignerName},
			#{birthDate},
			#{gender},
			#{foreignerStatus},
			#{phoneNum},
			#{mobileCarrier},
			#{privateInfoTerms},
			#{uniqueIdentifyTerms},
			#{mobileCarrierTerms},
			NOW()
		)
	</insert>
	<insert id="insertUserAuthority">
		INSERT INTO user_authority (user_id, authority_name)
		VALUES (
		    (SELECT user_id 
		     FROM user_info 
		     WHERE email = #{email}), 
		    #{authorityName}
		)		
	</insert>
	<insert id="insertRefreshToken">
		INSERT INTO user_token (user_id, refresh_token) 
		VALUES ( 
			(SELECT user_id 
			 FROM user_info
			 WHERE email = #{email}),
			#{refreshToken}
		)	
	</insert>
	<!-- 유저정보 가져오기 -->
	<select id="findOneWithAuthoritiesByUsername" resultType="kr.co.smh.config.jwt.model.User">
		SELECT user_id, email as username, password
		FROM user_info
		WHERE email = #{email}
	</select> 
	<select id="findOneWithAuthorityName" resultType="kr.co.smh.config.jwt.model.Authority">
		select authority_name
		from user_authority 
		where user_id = #{userId}
	</select> 	
	<!-- refresh Token 가져오기 -->
	<select id="getRefreshToken" resultType="String">
		SELECT ut.refresh_token 
		FROM user_token ut 
		LEFT JOIN user_info ui ON ui.user_id  = ut.user_id 
		WHERE ui.email = #{email}	
	</select>
</mapper>